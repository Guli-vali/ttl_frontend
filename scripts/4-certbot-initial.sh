#!/bin/bash
set -e

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ scripts/deploy.env
ENV_FILE="$(dirname "$0")/deploy.env"
if [ ! -f "$ENV_FILE" ]; then
  echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è: $ENV_FILE"
  exit 1
fi

source "$ENV_FILE"

cd $PROJECT_DIR

echo "üìÇ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
mkdir -p "$WEBROOT_PATH"
mkdir -p "$SSL_PATH"

echo "üöÄ –ó–∞–ø—É—Å–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ nginx –Ω–∞ 80 –ø–æ—Ä—Ç—É –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏..."
docker run --rm -d \
  --name certbot-nginx-temp \
  -v "$WEBROOT_PATH:/usr/share/nginx/html" \
  -p 80:80 \
  nginx:alpine

echo "üîê –ó–∞–ø—Ä–æ—Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –æ—Ç Let's Encrypt..."
docker run --rm \
  -v "$SSL_PATH:/etc/letsencrypt" \
  -v "$WEBROOT_PATH:/var/www/certbot" \
  certbot/certbot certonly \
  --webroot \
  --webroot-path=/var/www/certbot \
  --email $EMAIL \
  --agree-tos \
  --no-eff-email \
  -d $DOMAIN -d www.$DOMAIN

echo "üßπ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ nginx..."
docker stop certbot-nginx-temp

echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ $SSL_PATH"